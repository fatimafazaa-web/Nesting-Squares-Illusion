<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تجربة المربعات المتداخلة مع صورة / Canva</title>
  <style>
    body { font-family: system-ui, Arial; padding: 20px; direction: rtl; }
    h2 { margin: 0 0 8px 0; }
    ul { list-style: none; margin: 6px 0 6px 18px; padding-left: 8px; }
    li { margin: 6px 0; }
    label { cursor: pointer; user-select: none; display: inline-flex; gap: 8px; align-items: center; }
    .controls { margin-top: 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .box { background:#f7f7f7; padding:12px; border-radius:6px; display:inline-block; vertical-align:top; }
    .image-panel { display:inline-block; margin-left:18px; vertical-align:top; max-width:360px; }
    .image-panel img, .image-panel iframe { display:block; max-width:100%; height:auto; border-radius:6px; border:1px solid #ddd; background:#fff; }
    .image-actions { margin-top:8px; display:flex; gap:6px; align-items:center; }
    .muted { color:#666; font-size:0.95rem; margin-bottom:8px; }
    button, input[type="file"] { cursor:pointer; padding:8px 10px; border-radius:6px; border:0; background:#e0e0e0; }
    button:hover { background:#d0d0d0; }
    small { color:#444; }
    .yesno { margin-left:8px; display:inline-flex; gap:6px; }
    .yesno button { padding:2px 8px; border-radius:6px; border:0; background:#e6e6e6; cursor:pointer; font-size:0.85rem; }
    .yesno button.yes { background:#cfead6; }
    .yesno button.no  { background:#f6cfcf; }
    .global-yesno { margin-left:8px; display:inline-flex; gap:8px; }
    .global-yesno button { padding:8px 10px; border-radius:6px; border:0; background:#e8e8e8; }
    @media (max-width:720px) {
      .image-panel { display:block; margin:12px 0 0 0; max-width:100%; }
      .box { display:block; width:100%; margin-bottom:12px; }
    }
  </style>
</head>
<body>
  <h2>تجربة المربعات المتداخلة — مع صورة / تصميم Canva</h2>
  <p class="muted">حمّلي صورة للاختبار أو استخدمي الصورة العيّنة أو اعرضي تصميم Canva المضمّن. المعلومات أسفل المعاينة تُظهر اسم الصورة والأبعاد وحجم الملف إن توافرت.</p>

  <div class="controls">
    <label>
      <input id="fileInput" type="file" accept="image/*" style="display:none">
      <button id="chooseBtn" type="button">اختيار صورة</button>
    </label>
    <button id="sampleBtn" type="button">استخدام صورة عيّنة</button>
    <button id="canvaBtn" type="button">عرض تصميم Canva</button>
    <button id="clearBtn" type="button">إزالة الصورة/التصميم</button>

    <div class="global-yesno" style="margin-right:12px;">
      <button id="yesAll" type="button">نعم للجميع</button>
      <button id="noAll" type="button">لا للجميع</button>
    </div>
  </div>

  <div style="margin-top:12px;">
    <div class="box" id="checkboxBox" aria-label="قائمة المربعات">
      <ul>
        <li>
          <label><input type="checkbox"> العناصر الرئيسيـة</label>
          <ul>
            <li>
              <label><input type="checkbox"> مجموعة A</label>
              <ul>
                <li><label><input type="checkbox"> A1</label></li>
                <li><label><input type="checkbox"> A2</label></li>
                <li><label><input type="checkbox"> A3</label></li>
              </ul>
            </li>

            <li>
              <label><input type="checkbox"> مجموعة B</label>
              <ul>
                <li><label><input type="checkbox"> B1</label></li>
                <li><label><input type="checkbox"> B2</label></li>
              </ul>
            </li>

            <li>
              <label><input type="checkbox"> عنصر منفرد</label>
            </li>
          </ul>
        </li>
      </ul>

      <div class="controls" style="margin-top:10px;">
        <button id="reset">إعادة تعيين</button>
        <button id="check-all">تحديد الكل</button>
      </div>
    </div>

    <div class="image-panel" id="imagePanel" aria-hidden="false" style="display:inline-block;">
      <div class="muted">معاينة الصورة / التصميم:</div>

      <!-- حاوية عرض ديناميكية: افتراضيًا تعرض صورة من المستودع (raw) -->
      <div id="previewContainer">
        <img id="preview" alt="معاينة الصورة" src="https://raw.githubusercontent.com/fatimafazaa-web/Nesting-Squares-Illusion/81bf479df6a27b18ee1d1eb980e92ff13deab1c4/20260105_043927_%D9%A0%D9%A0%D9%A0%D9%A0.png" style="border-radius:6px;">
      </div>

      <div class="image-actions">
        <small id="imageName" style="align-self:center;color:#444;">تصميم من المستودع</small>
        <small id="imageInfo" style="align-self:center;color:#666;margin-right:8px;"></small>
      </div>
    </div>
  </div>

  <script>
    // ===== المربعات المتداخلة =====
    document.querySelectorAll('#checkboxBox input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const checkbox = e.target;
        setChildrenChecked(checkbox, checkbox.checked);
        updateParents(checkbox);
      });
    });

    function setChildrenChecked(checkbox, checked) {
      const li = checkbox.closest('li');
      if (!li) return;
      const childCheckboxes = li.querySelectorAll('ul input[type="checkbox"]');
      childCheckboxes.forEach(c => { c.checked = checked; c.indeterminate = false; });
    }

    function updateParents(startCheckbox) {
      let currentLi = startCheckbox.closest('li');
      while (true) {
        const parentUl = currentLi ? currentLi.parentElement : null;
        if (!parentUl) break;
        const parentLi = parentUl.closest('li');
        if (!parentLi) break;

        const parentCheckbox = parentLi.querySelector(':scope > label input[type="checkbox"]') || parentLi.querySelector('input[type="checkbox"]');
        if (!parentCheckbox) { currentLi = parentLi; continue; }

        const childCheckboxes = parentLi.querySelectorAll(':scope > ul input[type="checkbox"]');
        let checkedCount = 0;
        childCheckboxes.forEach(c => { if (c.checked) checkedCount++; });

        if (checkedCount === 0) { parentCheckbox.checked = false; parentCheckbox.indeterminate = false; }
        else if (checkedCount === childCheckboxes.length) { parentCheckbox.checked = true; parentCheckbox.indeterminate = false; }
        else { parentCheckbox.checked = false; parentCheckbox.indeterminate = true; }

        currentLi = parentLi;
      }
    }

    document.getElementById('reset').addEventListener('click', () => {
      document.querySelectorAll('#checkboxBox input[type="checkbox"]').forEach(c => { c.checked = false; c.indeterminate = false; });
    });
    document.getElementById('check-all').addEventListener('click', () => {
      document.querySelectorAll('#checkboxBox input[type="checkbox"]').forEach(c => { c.checked = true; c.indeterminate = false; });
    });

    // ===== أزرار نعم/لا لكل عنصر و للجميع (إصلاح: ربط مستمعين مباشرة لكل زر) =====
    // أضفنا أزرار نعم/لا بجانب كل label برمجياً، ثم أضفنا مستمعي click مباشرة للأزرار
    document.querySelectorAll('#checkboxBox label').forEach(label => {
      const cb = label.querySelector('input[type="checkbox"]');
      if (!cb) return;
      if (label.querySelector('.yesno')) return;

      const span = document.createElement('span');
      span.className = 'yesno';
      span.innerHTML = '<button class="yes" type="button" aria-label="نعم">نعم</button><button class="no" type="button" aria-label="لا">لا</button>';
      label.appendChild(span);

      // الآن نربط المستمعين مباشرة بالأزرار لضمان تحكم دقيق ومنع تأثير الـ label
      const yesBtn = span.querySelector('.yes');
      const noBtn  = span.querySelector('.no');

      yesBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation(); // يمنع تفعيل الـ label
        cb.checked = true;
        cb.indeterminate = false;
        setChildrenChecked(cb, true);
        updateParents(cb);
      });

      noBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation(); // يمنع تفعيل الـ label
        cb.checked = false;
        cb.indeterminate = false;
        setChildrenChecked(cb, false);
        updateParents(cb);
      });
    });

    const yesAllBtn = document.getElementById('yesAll');
    const noAllBtn  = document.getElementById('noAll');
    yesAllBtn.addEventListener('click', () => {
      document.querySelectorAll('#checkboxBox input[type="checkbox"]').forEach(c => { c.checked = true; c.indeterminate = false; });
    });
    noAllBtn.addEventListener('click', () => {
      document.querySelectorAll('#checkboxBox input[type="checkbox"]').forEach(c => { c.checked = false; c.indeterminate = false; });
    });

    // ===== عرض الصورة / تبديل iframe واظهار معلومات الصورة =====
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const canvaBtn = document.getElementById('canvaBtn');
    const clearBtn = document.getElementById('clearBtn');
    const imagePanel = document.getElementById('imagePanel');
    const previewContainer = document.getElementById('previewContainer');
    const imageName = document.getElementById('imageName');
    const imageInfo = document.getElementById('imageInfo');

    // رابط التصميم الذي أعطيتِه (يمكن تغييره هنا)
    const rawCanvaUrl = 'https://www.canva.com/design/DAG9gRCHk3I/hYz-HrP8CQLe4_FQA6mRkw/view';
    const canvaEmbedUrl = rawCanvaUrl.includes('?') ? rawCanvaUrl + '&embed' : rawCanvaUrl + '?embed';

    // حدث تحميل الصورة الافتراضية لعرض المعلومات
    function setInfoForImgElement(imgEl, originFile) {
      imageName.textContent = originFile && originFile.name ? originFile.name : (imgEl.src ? imgEl.src.split('/').pop() : 'صورة');
      imageInfo.textContent = 'جاري الحصول على المعلومات...';
      if (imgEl.complete && imgEl.naturalWidth) {
        updateInfoWithDimensions(imgEl, originFile);
      } else {
        imgEl.addEventListener('load', () => updateInfoWithDimensions(imgEl, originFile), { once: true });
        imgEl.addEventListener('error', () => { imageInfo.textContent = 'فشل تحميل الصورة'; }, { once: true });
      }
      if (originFile && originFile.size) {
        const kb = Math.round(originFile.size / 1024);
        imageInfo.dataset.size = kb + 'KB';
      } else {
        if (imgEl.src && imgEl.src.startsWith('https://raw.githubusercontent.com')) {
          fetch(imgEl.src, { method: 'HEAD' }).then(resp => {
            const len = resp.headers.get('content-length');
            if (len) imageInfo.dataset.size = Math.round(Number(len) / 1024) + 'KB';
          }).catch(()=>{/* لا نعرض خطأ */});
        }
      }
    }

    function updateInfoWithDimensions(imgEl, originFile) {
      const dims = `${imgEl.naturalWidth}px × ${imgEl.naturalHeight}px`;
      const sizeText = imageInfo.dataset.size ? ' — ' + imageInfo.dataset.size : '';
      imageInfo.textContent = dims + sizeText;
    }

    // زر اختيار ملف من الجهاز
    chooseBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return clearPreview();
      if (!file.type.startsWith('image/')) { alert('الملف ليس صورة.'); return; }
      const reader = new FileReader();
      reader.onload = (ev) => {
        previewContainer.innerHTML = '<img id="preview" alt="معاينة الصورة" src="" style="border-radius:6px;">';
        const imgEl = previewContainer.querySelector('#preview');
        imgEl.src = ev.target.result;
        setInfoForImgElement(imgEl, file);
        showImagePanel();
      };
      reader.readAsDataURL(file);
    });

    // زر استخدام صورة عيّنة
    sampleBtn.addEventListener('click', () => {
      previewContainer.innerHTML = '<img id="preview" alt="معاينة الصورة" src="https://images.unsplash.com/photo-1542281286-9e0a16bb7366?w=800&q=60&auto=format&fit=crop" style="border-radius:6px;">';
      const imgEl = previewContainer.querySelector('#preview');
      setInfoForImgElement(imgEl, null);
      imageName.textContent = 'صورة عيّنة';
      showImagePanel();
    });

    // زر عرض تصميم Canva (ينشئ iframe برمجياً)
    canvaBtn.addEventListener('click', () => {
      previewContainer.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = canvaEmbedUrl;
      iframe.width = '100%';
      iframe.height = '360';
      iframe.frameBorder = '0';
      iframe.setAttribute('allowfullscreen', '');
      iframe.loading = 'lazy';
      iframe.title = 'تصميم من Canva';
      previewContainer.appendChild(iframe);
      imageName.textContent = 'تصميم من Canva';
      imageInfo.textContent = '';
      showImagePanel();
    });

    // زر الإزالة: يعيد الحاوية إلى عنصر img فارغ ويخفي اللوحة
    clearBtn.addEventListener('click', clearPreview);

    function showImagePanel() {
      imagePanel.style.display = 'inline-block';
      imagePanel.setAttribute('aria-hidden','false');
    }
    function clearPreview() {
      previewContainer.innerHTML = '<img id="preview" alt="معاينة الصورة" src="">';
      imageName.textContent = '';
      imageInfo.textContent = '';
      delete imageInfo.dataset.size;
      fileInput.value = '';
      imagePanel.style.display = 'none';
      imagePanel.setAttribute('aria-hidden','true');
    }

    // عند تحميل الصفحة: حدّث معلومات الصورة الافتراضية إن ظهرت
    window.addEventListener('load', () => {
      const imgEl = previewContainer.querySelector('img');
      if (imgEl && imgEl.src) {
        setInfoForImgElement(imgEl, null);
      }
    });

    // ملاحظة: بعض تصميمات Canva تمنع التضمين داخل iframe (X-Frame-Options).
    // إن لم يظهر iframe بعد الضغط على "عرض تصميم Canva"، استخدمي زر "اختيار صورة" بعد تنزيل التصميم كصورة.
  </script>
</body>
</html>
